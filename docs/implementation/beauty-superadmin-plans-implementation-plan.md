# 課金・プラン管理画面実装計画

## 1. 実装概要

美姫命アプリケーションのスーパー管理者向け課金・プラン管理画面を実装します。この機能では、サービスプランの設定、請求書管理、収益シミュレーション、およびUniverpay決済サービスとの連携機能を提供します。

## 2. 主要機能

1. **プラン管理**
   - プラン一覧表示
   - プランの作成・編集・削除
   - プラン詳細設定（料金、機能リスト、上限設定など）

2. **請求書管理**
   - 請求書一覧表示とフィルタリング
   - 請求書詳細表示
   - 請求書ステータス更新
   - 支払い催促メール送信

3. **収益シミュレーション**
   - API使用量の集計と表示
   - 料金パラメータ調整によるシミュレーション
   - 推奨トークン配布量の計算

4. **支払い状態管理**
   - 支払い遅延組織の一覧表示
   - 組織のアクセス停止/復元
   - 支払い状態の一括チェック

5. **Univerpay決済連携**
   - トランザクショントークンの生成と管理
   - 定期課金設定
   - Webhook受信による支払い状態の自動更新

## 3. 画面構成

1. **プラン設定タブ**
   - プラン一覧（カード形式）
   - プラン作成・編集モーダル

2. **請求管理タブ**
   - 支払い状態サマリー
   - 請求書一覧（テーブル形式）
   - 請求書詳細モーダル
   - 支払い催促・アクセス停止モーダル

3. **収益シミュレーションタブ**
   - API使用量サマリー
   - トークン消費量グラフ
   - シミュレーションパラメータ調整セクション
   - シミュレーション結果表示

## 4. データフロー

### プラン管理フロー
1. プラン一覧読み込み
   - API呼び出し → 状態更新 → UI表示
2. プラン作成フロー
   - フォーム入力 → バリデーション → API呼び出し → 状態更新
3. プラン編集フロー
   - データ取得 → フォーム表示 → 編集 → API呼び出し → 状態更新

### 請求書管理フロー
1. 請求書一覧読み込み
   - API呼び出し → 状態更新 → UI表示
2. 請求書ステータス更新
   - ステータス選択 → API呼び出し → 状態更新
3. 支払い催促フロー
   - 催促メッセージ入力 → API呼び出し → 通知表示

### 支払い状態管理フロー
1. 支払い状態更新
   - Webhook受信 → 状態更新 → 必要に応じてアクセス制限
2. アクセス復元フロー
   - 復元オプション選択 → API呼び出し → 状態更新

## 5. コンポーネント構造

```
src/
└── components/
    └── SuperAdmin/
        └── Plans/
            ├── index.tsx                    # メインページコンポーネント
            ├── PlansTab/                    # プラン設定タブ
            │   ├── index.tsx                # プラン設定タブメイン
            │   ├── PlanCard.tsx             # プランカード
            │   ├── PlanFormModal.tsx        # プラン作成・編集モーダル
            │   └── FeatureListEditor.tsx    # 機能一覧エディタ
            ├── InvoicesTab/                 # 請求管理タブ
            │   ├── index.tsx                # 請求管理タブメイン
            │   ├── PaymentStatusSummary.tsx # 支払い状態サマリー
            │   ├── InvoiceTable.tsx         # 請求書テーブル
            │   ├── InvoiceDetailModal.tsx   # 請求書詳細モーダル
            │   ├── PaymentReminderModal.tsx # 支払い催促モーダル
            │   ├── AccessSuspendModal.tsx   # アクセス停止モーダル
            │   └── AccessRestoreModal.tsx   # アクセス復元モーダル
            └── SimulationTab/               # 収益シミュレーションタブ
                ├── index.tsx                # シミュレーションタブメイン
                ├── ApiUsageSummary.tsx      # API使用量サマリー
                ├── UsageChart.tsx           # 使用量グラフ
                ├── SimulationParams.tsx     # シミュレーションパラメータ
                └── SimulationResults.tsx    # シミュレーション結果
```

## 6. サービス層の設計

```
src/
└── services/
    ├── admin/
    │   ├── plan.service.ts         # プラン管理API連携
    │   ├── invoice.service.ts      # 請求書管理API連携
    │   └── simulation.service.ts   # シミュレーションAPI連携
    └── payment/
        ├── univerpay.service.ts    # Univerpay API連携
        └── webhook.service.ts      # Webhook処理
```

### プラン管理サービス（plan.service.ts）
- getPlans(): プラン一覧取得
- getPlanById(id): プラン詳細取得
- createPlan(data): プラン作成
- updatePlan(id, data): プラン更新
- deletePlan(id): プラン削除

### 請求書管理サービス（invoice.service.ts）
- getInvoices(filters): 請求書一覧取得
- getInvoiceById(id): 請求書詳細取得
- updateInvoiceStatus(id, status): 請求書ステータス更新
- createInvoice(data): 請求書作成
- getInvoicePdf(id): 請求書PDF取得
- resendInvoice(id, options): 請求書再送信
- remindInvoice(id, message): 支払い催促

### 支払い状態管理サービス（payment-status.service.ts）
- updatePaymentStatus(orgId, status): 支払い状態更新
- getPaymentStatusDetail(orgId): 支払い状態詳細取得
- getOverdueOrganizations(filters): 支払い遅延組織取得
- restoreAccess(orgId, options): アクセス復元
- batchCheck(options): 一括支払い状態チェック
- sendPaymentReminder(orgId, message): 支払い催促メール送信

### Univerpay連携サービス（univerpay.service.ts）
- createTransactionToken(data): トランザクショントークン作成
- getTransactionToken(id): トランザクショントークン取得
- updateTransactionToken(id, data): トランザクショントークン更新
- createSubscription(tokenId, data): サブスクリプション作成
- cancelSubscription(id): サブスクリプションキャンセル

## 7. 状態管理設計

1. **グローバル状態** (Context APIで管理)
   - 認証情報
   - 通知メッセージ
   - 共通設定

2. **ローカル状態** (各コンポーネントでuseStateで管理)
   - UI表示状態（モーダル表示など）
   - フォーム入力値
   - ページング情報

3. **タブレベルの状態** (各タブコンポーネント内で管理)
   - プラン一覧データ
   - 請求書一覧データ
   - シミュレーション結果データ

## 8. Univerpay連携の実装計画

1. **環境設定**
   - テスト環境と本番環境の切り替え設定
   - APIキーとシークレットの安全な管理

2. **トランザクショントークン管理**
   - ユーザーカード情報の収集UI
   - トランザクショントークン生成API連携
   - トークン情報の安全な保存

3. **サブスクリプション管理**
   - プラン情報に基づくサブスクリプション作成
   - サブスクリプション状態の監視と管理

4. **Webhook処理**
   - Webhookエンドポイントの実装
   - イベントタイプに応じた処理ロジック
   - 支払い状態の自動更新

5. **エラーハンドリング**
   - API呼び出しエラーの処理
   - 決済エラーの適切な処理と通知

## 9. 実装優先順位と段階的実装計画

### Phase 1: 基本的なプラン管理（1-2週間）
1. プラン管理タブの基本UI実装
2. プラン一覧表示機能
3. プラン作成・編集モーダル
4. APIとの連携実装

### Phase 2: 請求書管理（1-2週間）
1. 請求書管理タブの基本UI実装
2. 請求書一覧表示と詳細表示
3. 請求書ステータス更新機能
4. フィルタリングとページネーション

### Phase 3: Univerpay連携（2週間）
1. トランザクショントークン生成機能
2. サブスクリプション管理機能
3. Webhook受信と処理機能
4. エラーハンドリングと通知機能

### Phase 4: 支払い状態管理（1-2週間）
1. 支払い状態サマリー表示
2. 組織アクセス停止/復元機能
3. 支払い催促メール送信機能
4. 一括処理機能

### Phase 5: 収益シミュレーション（1-2週間）
1. API使用量データ表示
2. シミュレーションパラメータ調整UI
3. シミュレーション結果表示
4. グラフ表示機能

### Phase 6: 最適化とテスト（1週間）
1. パフォーマンス最適化
2. エラー処理の改善
3. ユーザビリティ改善
4. テストの実施と修正

## 10. テスト計画

1. **単体テスト**
   - コンポーネントの動作確認
   - サービス層の機能テスト
   - バリデーションロジックのテスト

2. **統合テスト**
   - データフローの検証
   - API連携の検証
   - エラー処理の検証

3. **Univerpay連携テスト**
   - テスト環境での決済フロー検証
   - Webhook処理の検証
   - エラーケースのシミュレーション

4. **ユーザビリティテスト**
   - 管理者向けユーザビリティ確認
   - 操作フローの最適化

## 11. 課題と検討事項

1. **PCI DSS準拠**
   - クレジットカード情報を直接扱わない方法の検討
   - Univerpayのウィジェットまたはiframeの活用

2. **エラー処理と復旧**
   - 決済失敗時の適切なフォールバック処理
   - 自動再試行のポリシー設定

3. **セキュリティ対策**
   - 認証情報の安全な管理
   - 通信の暗号化
   - 入力データの検証

4. **パフォーマンス最適化**
   - データ取得の最適化
   - UI表示の効率化
   - ページングと遅延読み込みの実装

## 12. 実装進捗状況（2025/5/1更新）

### 現在の実装状況

1. **バックエンド側の実装**
   - ✅ サブスクリプション管理サービス（subscription.service.ts）
   - ✅ 請求書管理サービス（invoice.service.ts）
   - ✅ 組織管理サービス（organization.service.ts）
   - ✅ 通知サービス（notification.service.ts）
   - ✅ 監査ログサービス（audit-log.service.ts）
   - ✅ Univerpay連携サービス（univerpay.service.ts）
   - ✅ Webhook処理コントローラ（payment-webhook.controller.ts）

2. **フロントエンド側の実装**
   - ✅ プラン管理タブの基本構造
     - ✅ プラン一覧表示（PlanCard.tsx）
     - ✅ プラン作成・編集モーダル（PlanFormModal.tsx）
     - ✅ 機能リスト編集（FeatureListEditor.tsx）
   - ✅ 請求書管理タブの基本構造
     - ✅ 支払い状態サマリー（PaymentStatusSummary.tsx）
     - ✅ 請求書一覧（InvoiceTable.tsx）
     - ✅ 請求書詳細モーダル（InvoiceDetailModal.tsx）
     - ✅ 支払い催促機能（PaymentReminderModal.tsx）
     - ✅ アクセス停止機能（AccessSuspendModal.tsx）
   - ✅ 収益シミュレーションタブの基本構造
     - ✅ シミュレーション基本画面（index.tsx）
     - ⬜ API使用量サマリー（ApiUsageSummary.tsx）
     - ⬜ 使用量グラフ（UsageChart.tsx）
     - ⬜ シミュレーションパラメータ（SimulationParams.tsx）
     - ⬜ シミュレーション結果（SimulationResults.tsx）

3. **Univerpay決済連携**
   - ✅ トランザクショントークン生成機能
   - ✅ サブスクリプション管理機能
   - ✅ Webhook受信エンドポイント実装
   - ✅ 支払い状態の自動更新機能
   - ✅ 認証と署名検証処理
   - ⬜ 3Dセキュア認証対応（オプション）

### 残りの実装タスク

1. **フロントエンドの詳細実装**
   - シミュレーションタブの子コンポーネント実装
   - Univerpayウィジェットまたはカード入力フォームの実装
   - API連携の完了とエラーハンドリングの強化
   - UI/UXの調整（ピンク系カラーパレットへの変更）

2. **テストと品質保証**
   - ユニットテストの実施
   - Webhook処理のエンドツーエンドテスト
   - 決済フローテスト（テスト環境での検証）
   - エラーケースのシミュレーションテスト

3. **ドキュメント作成**
   - 管理者向け操作マニュアル
   - 開発者向けメンテナンス手順書
   - 決済処理トラブルシューティングガイド

### 実装上の注意点

1. **Univerpay連携におけるセキュリティ**
   - 認証情報の厳重な管理
   - Webhook署名検証の徹底
   - PCI DSS対応のためのトークン化処理

2. **決済処理のエラーハンドリング**
   - 支払い失敗時の適切なユーザーフィードバック
   - リトライ処理と通知の実装
   - 復旧手順の明確化

## 13. まとめ

本実装計画では、美姫命アプリケーションのスーパー管理者向け課金・プラン管理画面の実装について詳細に説明しました。段階的な実装アプローチにより、基本機能から高度な機能まで順次開発を進めています。また、Univerpay決済サービスとの連携により、安全かつ効率的な課金管理を実現します。

バックエンド側の実装はほぼ完了し、フロントエンド側の基本構造も実装が進んでいます。今後は収益シミュレーション機能の詳細実装とUI/UXの調整に重点を置き、実装を完了させる予定です。実装中に発生する課題や仕様変更に柔軟に対応しながら、使いやすく信頼性の高い管理機能を提供することを目指します。