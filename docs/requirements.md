# 要件定義書: いろは（iroha）- 四柱推命ヘアスタイリングアプリケーション

## 1. プロジェクト概要

「いろは」は、既存の四柱推命（Daily Fortune）アプリケーションを美容師・美容サロン向けに特化させたアプリケーションです。四柱推命の原理に基づいてクライアント（お客様）の命式を分析し、最適なヘアスタイルや色の提案、スタイリストとクライアントの相性診断などを行うことができます。

## 2. 目標とゴール

- 美容師がクライアントの四柱推命に基づく最適なヘアスタイルを提案できるツールの提供
- クライアントとスタイリストの相性を五行（水・木・火・土・金）によって診断し、マッチング率を向上
- 顧客管理とカルテ・予約情報管理を四柱推命情報と統合
- 五行に基づくパーソナライズされたヘアスタイルとカラー提案機能
- ホットペッパービューティーや電子カルテシステムとのデータ連携

## 2.5 管理哲学と責任階層（現在のリファクタリング対象）

いろははマルチテナント構造を採用し、管理権限を明確に階層化します：

### スーパー管理者（SuperAdmin）の責任範囲

- **組織（サロン）管理に特化**: 組織単位の作成・管理のみを行う
- **サブスクリプション管理**: プラン設定、契約管理、更新処理
- **請求・支払い管理**: 課金状況の管理、未払いの検知、支払い履歴
- **組織の有効/無効管理**: サロン全体の稼働状態管理、アクセス停止
- **組織オーナーの設定**: 組織作成時に初期管理者（オーナー権限）アカウントを設定

SuperAdminは組織レベルの操作に集中し、個別ユーザー（スタイリスト）管理の機能は持たず、組織内部の詳細には干渉しません。すべてのユーザー管理は組織オーナーに委任されます。

#### 2025年4月機能リファクタリング方針
- SuperAdmin向け個別ユーザー管理画面を廃止
- 組織管理画面に初期管理者設定機能を統合
- 組織管理に特化したシンプルなインターフェースに変更（メニュー項目を「組織管理」「課金・プラン管理」「サポート管理」の3つに限定）
- 余計な情報収集を減らし、必要最小限のフィールドでシンプルなフォームに簡素化（組織メールアドレス、地域などを削除）

### 組織オーナー（Owner）の責任範囲

- **組織の存続に関わる決定**: 組織アカウントの削除申請、重要設定の変更
- **課金情報の管理**: 支払い情報の更新、サブスクリプションプランの変更
- **管理者（Admin）の管理**: 管理者権限を持つユーザーの追加・編集・削除
- **組織設定の管理**: サロン基本情報や運用設定の変更
- **全機能へのアクセス**: 組織内のすべての機能とデータへのアクセス
- **API連携とデータインポート**: 外部システムとの連携設定

### 管理者（Admin）の責任範囲

- **自組織内のユーザー管理**: スタイリストの追加・編集・削除
- **一般的な組織設定の管理**: 日常運用に関わる設定変更
- **日常的な運用管理**: スタイリストの割り当てなど
- **クライアントデータの一括管理**: サロン全体の顧客データ管理
- **レポート閲覧と分析**: 業績データの確認と分析

### スタイリスト（User）の責任範囲

- **クライアント対応**: 実際の美容施術とアドバイス
- **クライアント情報管理**: 顧客データの入力と管理
- **予約管理**: スケジュール確認と対応
- **四柱推命ベースの提案**: 占いを活用した施術提案

### ロール階層の特徴

システム内のロールは以下の4階層で構成され、上位権限は下位のすべての権限を継承します：

1. **SuperAdmin**: システム全体の管理権限（サービス提供者側の権限）
   - 複数の組織（サロン）を管理できる
   - プラットフォーム全体の設定や監視が可能
   - システム提供会社のスタッフのみが持つ権限

2. **Owner**: 特定の組織（サロン）の所有者権限（顧客側の最高権限）
   - 自組織内でのみ最高権限を持つ
   - 組織の存続に関わる重要な決定ができる
   - サロンのオーナーや経営者が持つ権限

3. **Admin**: 組織内の管理者権限
   - 日常的な組織運営の権限を持つ
   - 店長やマネージャーが持つ権限

4. **User**: 一般スタイリスト権限
   - 通常のスタイリスト業務のみ可能

各組織は作成時に少なくとも1人のOwnerが設定され、Ownerのみが組織内でAdmin権限を付与できます。SuperAdminは組織を横断して管理できますが、Ownerは自分の組織のみを管理します。

### 各ロールがアクセスできるアプリケーション

各ロールは以下のアプリケーションにアクセスできます：

1. **SuperAdmin**:
   - SuperAdmin管理サイト（システム全体の管理用Webアプリケーション）のみ

2. **Owner**:
   - サロン管理者サイト（Admin）での組織管理
   - スタイリスト用モバイルアプリ（Client）でのスタイリスト業務も可能
   
3. **Admin**:
   - サロン管理者サイト（Admin）での日常運営管理
   - スタイリスト用モバイルアプリ（Client）でのスタイリスト業務も可能
   
4. **User**:
   - スタイリスト用モバイルアプリ（Client）のみ

これにより、サロンのオーナーや管理者は必要に応じて管理業務とスタイリスト業務の両方を行うことができます。

現在、この明確な責任分離への移行作業を進めており、特にSuperAdmin機能の組織管理特化と不要機能の廃止を行っています。また、組織内のOwnerとAdmin権限の区分けを明確にしています。

## 3. ターゲットユーザー

- **主要ターゲット**: 美容師、美容サロン経営者
- **副次ターゲット**: 美容サロンの顧客（エンドユーザー）
- **年齢層**: 20代〜50代
- **技術レベル**: 中程度（スマートフォンやタブレットの基本操作ができるレベル）

## 4. システム全体構成

本システムは以下の3つの主要アプリケーションで構成されます：

### 4.1 主要アプリケーション構成

1. **SuperAdmin管理サイト**：
   - プラットフォーム全体を管理するシステム管理者向けWebアプリケーション
   - 組織（サロン）管理に特化した単純化されたインターフェース
   - サブスクリプションと課金管理
   - 組織オーナーの設定
   - サポートチケット管理
   - モックアップ: `/mockups/beauty-superadmin-*.html`
   - 詳細要件: `/docs/superadmin-requirements.md`

2. **サロン管理者サイト（Admin）**：
   - 個別の美容サロンの管理者（オーナー・店長等）向けのWebアプリケーション
   - データ管理、スタッフ管理、分析機能
   - クライアント管理と予約管理
   - カレンダー連携設定
   - モックアップ: `/mockups/beauty-admin-*.html`

3. **スタイリスト用モバイルアプリ（Client）**：
   - 美容師が日常業務で使用するモバイルアプリケーション
   - モバイルファーストのレスポンシブデザイン
   - クライアント（お客様）との施術時に活用
   - 四柱推命に基づくパーソナライズされた提案機能
   - チャットインターフェースによる相談機能
   - モックアップ: `/mockups/beauty-client-*.html`

### 4.2 データフローと連携

1. **外部連携層**：
   - カレンダーサービス（Google/Apple）を中間連携層として活用
   - データフロー: 外部予約システム → カレンダーサービス → いろはアプリ
   - 定期的な同期による予約情報の自動取得

2. **統合データベース**：
   - クライアント情報、スタイリスト情報、予約情報の一元管理
   - 双方向データフロー:
     - Admin → DB → Client（スタイリスト/顧客情報の配信）
     - Client → DB → Admin（収集した誕生日情報などの集約）
   - カレンダー連携による未登録クライアントの自動仮登録
   - インクリメンタルデータ収集（初回は名前のみ、徐々に誕生日などを追加）

## 5. 機能要件

### 5.1 基盤機能（コア機能）

- クライアントの誕生日情報を保管し四柱推命データに変換する仕組み
- スタッフ（美容師）の誕生日情報を保管し四柱推命データに変換する仕組み
- 日柱情報の管理および毎日の更新
- OpenAIのGPT-4oモデルを使用したAIチャット機能
- サブスクリプションプランに基づくチャットトークン使用量の管理と制限
- APIトークンの追加チャージ購入機能
  - プラン上限を超過する場合の追加トークン購入オプション
  - スタンダードチャージ（1,000,000トークン）とプレミアムチャージ（10,000,000トークン）の2プラン
  - 購入したトークンは当月内のみ有効（翌月への繰り越しなし）
  - 購入後即時反映され、プラン上限に追加される
  - 請求書に自動的に追加される課金システム

### 5.2 スタイリスト用モバイルアプリケーション機能

#### 5.2.1 認証・アカウント管理
- 美容師（スタイリスト）アカウント登録・ログイン機能
- 美容サロン単位でのアカウント管理（管理者、スタイリスト権限分け）
- スタイリストプロフィール管理（名前、写真、経歴、得意分野、五行属性）

#### 5.2.2 個人運勢機能
- 日々の本人（スタイリスト）の運勢表示
- 運勢スコアおよび詳細アドバイスの表示
- 施術に関連するアドバイスの提供

#### 5.2.3 クライアント管理
- クライアント一覧表示・検索・フィルタリング
- クライアント情報の閲覧（基本情報（名前、性別、連絡先等）、命式情報、施術履歴）
- クライアントの五行特性表示（性格特性、相性のいいスタイル・カラー）
- クライアント直接入力機能（当日来店クライアントに誕生日・性別を入力してもらい、即時占い結果を表示）

#### 5.2.4 本日の施術予定
- 本日担当するクライアントの予定一覧表示
- クライアントの基本情報と四柱推命情報の確認
- クライアントとの相性情報の表示
- 会話トピック提案（クライアントの五行タイプに合わせた）
- クライアント詳細表示（モーダル形式）
  - 基本情報表示（名前、連絡先、誕生日など）
  - 時系列メモ管理機能
    - 過去のメモを日付順に表示
    - スタイリスト別の記録を確認可能
    - 新規メモの追加機能
  - 四柱推命情報の表示（日柱、五行バランス、本日の運勢）
  - AIヘアスタイル提案機能
    - 本日の日柱情報、会話メモ、四柱推命情報を元にGPT-4oモデルが最適なヘアスタイルを提案
    - カラー、カット、スタイリングそれぞれの具体的な提案内容
    - リロードボタンで提案を更新可能
    - サブスクリプションプランのトークン使用量制限に基づく利用
- クライアント専用チャット機能
  - 本日の施術予定画面からクライアントカードの詳細ボタンでチャット画面にアクセス可能
  - 選択したクライアント専用のチャットインターフェース（beauty-client-chat）
  - クライアントの四柱推命情報が自動的にコンテクストとして設定
  - クライアント向けの具体的な美容提案や相談が可能
  - チャット履歴はクライアントごとにサロン単位で保存・共有
- 管理サイトで登録されたスタイリスト情報の連携表示
- クライアントの誕生日情報収集機能
  - 誕生日未登録クライアントの識別表示
  - 簡易入力画面（beauty-client-input）の表示機能
  - 未登録クライアント情報収集フロー：
    - 本日の施術予定画面で未登録クライアントカードの「+」ボタン（add_circle）をタップ
    - beauty-client-input画面に遷移し、クライアント名が自動入力された状態で表示
    - 誕生日情報（生年月日・時間）と性別を入力
    - 「登録」ボタンをタップすると自動的にクライアントデータベースに情報が保存され四柱推命情報が計算される
    - 計算された四柱推命情報をコンテクストとしたクライアント専用チャット画面に遷移
    - 四柱推命情報を元にした対話型の美容提案・相談が可能
    - クライアントの具体的な質問や要望に応じたパーソナライズされた提案を会話形式で提供
    - チャット履歴とクライアント情報は連携して保存され、次回のアドバイスや提案の参考となる
    - 結果はクライアントデータに紐づけて保存され、次回からはクライアント情報に四柱推命データが表示される
  - 収集した誕生日情報の顧客データベースへの自動紐付け

#### 5.2.5 一般チャット相談 `/chat`
- スタイリスト自身の相談や学習のための一般的なチャットインターフェース
- OpenAIのGPT-4oモデルを活用した施術に関する相談機能
- サブスクリプションプランに基づくチャットトークン使用量制限
  - ベーシックプラン: 月間制限あり（プラン内容に準ずる）
  - スタンダードプラン: 月間制限あり（プラン内容に準ずる）
  - プレミアムプラン: 月間制限あり（プラン内容に準ずる）
- コンテクスト選択機能
  - スタッフ情報（自分自身の四柱推命情報など）
  - 任意のクライアント情報の追加
  - 四柱推命理論や美容知識の追加
- 一般的な美容相談や技術に関する質問が可能
- ナレッジベースとしての活用（「この色素の扱い方は？」「パーマの持ちを良くするには？」など）
- 特定のクライアントに関する相談も可能（「この色素で〇〇さんに合う色は？」など）
- トークン使用量モニタリングとリアルタイム通知（80%・95%・上限到達時）

#### 5.2.6 クライアント専用チャットシステム
- 特定クライアント専用のチャットインターフェース（5.2.4で言及したbeauty-client-chat）
- 複数アクセス経路
  - 本日の施術予定画面からクライアントカードの詳細ボタン経由
  - 誕生日情報登録直後の自動遷移
  - クライアント詳細モーダルからの遷移
- 多様なチャット活用シナリオ
  - ヘアスタイル・カラー提案のための対話型インターフェース
  - クライアントの質問に直接回答可能（「このカラーは似合う？」など）
  - 「この方に似合う髪型は？」「この方の肌に合う色は？」といった質問に四柱推命情報を基に回答
- チャットシステムの実装詳細
  - システムメッセージベースの構造
    - 各チャットセッション開始時にクライアントの四柱推命プロファイル情報を静的なシステムメッセージとして設定
    - 当日の日柱情報も自動的にシステムメッセージに含める（来店日が変わると自動更新）
    - スタイリスト・クライアント情報などの基本コンテクストも設定
  - メッセージの永続化と参照
    - チャットデータはデータベースに永続的に保存（削除操作がない限り維持）
    - 会話は常に続きから再開可能（セッションの概念なし）
    - AIモデルには直近15件程度のメッセージを参照コンテクストとして提供
    - 長期的な会話履歴からも重要情報を抽出し要約データとして保持
  - サロン全体での共有
    - チャット履歴はサロン単位で管理（特定のスタイリストではなく）
    - すべてのスタイリストが閲覧・継続可能な設計
    - 担当者が変わっても一貫したサービス提供が可能

#### 5.2.7 基本設定
- 自分のプロフィール情報の確認・編集
- 通知設定
- アプリの基本設定

### 5.3 サロン管理者サイト（Admin）機能

#### 5.3.1 クライアントデータ管理
- クライアントデータの一括インポート・エクスポート
- 誕生日情報の一括登録・更新
- クライアント情報の編集・管理
- メインアプリ（スタイリスト向け）との双方向データ連携
  - 管理サイトで更新されたクライアント情報のメインアプリへの反映
  - メインアプリで収集された誕生日情報の中央データベースへの反映
  - スタイリスト情報の共有（管理サイト → メインアプリ）
- GPT-4oモデルのトークン使用状況管理
  - サロン全体および各スタイリストのトークン使用量の確認
  - プラン上限に対する使用率の視覚的表示（プログレスバーによる使用率の視覚化）
  - 使用履歴と傾向分析レポート
  - 追加チャージされたトークン残量の表示と会話可能回数の目安表示
  - トークン使用量が特定の閾値（80%、95%など）に達した際の通知
  - トークン追加チャージ購入機能へのアクセス（オーナー権限のみ）
  - 請求書詳細にトークン使用状況の詳細表示

#### 5.3.2 スタイリスト管理
- スタイリスト情報管理（名前、メールアドレス、自由入力の役職）
- アカウント作成・編集・削除
- 権限設定（管理者/スタイリスト）
- パスワード管理
- 四柱推命プロフィールの閲覧（命式、五行バランス、性格特性など）
- 四柱推命情報の登録状態管理（登録済み/未登録の表示）

#### 5.3.3 予約・担当管理
- 未担当クライアントの担当者割り当て
- 施術スケジュール管理
- 最適マッチング提案（五行相性に基づく）の確認と調整

#### 5.3.4 クライアントベースの予約管理
- 日付別予約済みクライアント一覧表示（予約時間と担当状況がわかるよう表示）
- 時間枠ごとの予約カード表示と空き枠の視覚化
- 予約の新規追加・編集・移動の直感的なUI
  - 空き時間枠への予約追加（クリックで追加フォーム表示）
  - 既存予約のドラッグ&ドロップによる時間変更
  - 予約詳細の編集機能（顧客情報、施術内容、担当者の変更）
- クライアントカードをタップで詳細・担当設定
- カード内に相性上位スタイリストをサジェスト表示
- ワンタップでスタイリスト割り当て（相性スコア付き選択肢から選択）
- カード色による五行属性と性別の視覚化（女性/男性が一目でわかるデザイン）
- 未割り当て予約の視覚的強調表示

#### 5.3.5 データ連携設定
- Googleカレンダー/iCloudカレンダー連携機能
  - 外部カレンダーからの予約情報の自動取得
  - 予約情報と自社データベースの自動紐付け（クライアント名→クライアントID、スタイリスト名→スタイリストID）
  - 外部予約情報から既存クライアント情報の自動認識と紐付け
  - 未登録クライアントの自動仮登録と後からの情報補完機能
- 自社データベースと外部データの紐付け機能
  - カレンダーイベントから取得した予約情報を自社データベースのクライアント・スタイリスト情報と紐付け
  - 同一クライアントの識別（名前や電話番号による照合）と重複防止
  - マッチングできない予約情報の手動紐付け支援機能
- カレンダー経由での外部予約システム連携
  - ホットペッパービューティーやGoogle予約などのサービスとGoogleカレンダー連携を活用した間接連携
  - 予約情報のテキストパターン認識によるクライアント情報の抽出（名前、メール、電話番号など）
  - 予約タイトルや説明文からの施術内容の自動分類
- データマッピングとマスターデータ管理
  - クライアント識別子（名前、電話番号、メールアドレス等）を使った自社システムとの紐付け
  - スタイリスト情報の連携
  - 施術内容の標準化とマッピング
- CSVフォーマットによるデータインポート/エクスポート
  - 既存顧客データの一括取り込み
  - カレンダー連携で取得できない詳細情報の補完
- 同期設定の詳細管理
  - カレンダー同期頻度の設定（5分〜1時間ごと）
  - 自動紐付けルールのカスタマイズ
  - 変更検知時の通知設定

#### 5.3.6 サポート管理
- サポートチケット作成・管理機能
  - 新規サポートチケット作成フォーム（タイトル、詳細内容）
  - チケット一覧表示と絞り込み（すべて、未回答、回答済み）
  - チケット詳細表示（メッセージ履歴、ステータス）
  - 返信機能（テキスト入力による返信）
- 通知機能
  - 新規チケット作成時のスーパー管理者への通知
  - スーパー管理者からの返信時のサロン管理者への通知
- チケットステータス管理
  - 未回答：新規作成時や問い合わせ続行時
  - 回答済み：スーパー管理者から返信があった時
- シンプルなUI/UX
  - 最小限の入力項目（タイトルと詳細のみ）
  - 直感的な操作フロー
  - 会話形式の履歴表示

### 5.4 SuperAdmin機能

#### 5.4.1 サポートチケット管理
- 全組織からのサポートチケット一元管理
  - チケット一覧表示と検索機能
  - 未回答チケットの優先表示
  - チケット詳細・会話履歴の表示
- チケット対応機能
  - テキスト返信機能
  - 返信時の自動ステータス更新（未回答→回答済み）
  - 優先度の視覚的表示（一覧での強調表示）
- 統計・レポート機能
  - 組織別のチケット数
  - 平均応答時間
  - 未解決チケット数の追跡

#### 5.4.2 GPT-4oトークン使用管理と収益シミュレーション
- 収益シミュレーションと一体化したAPI使用量分析
  - 総トークン使用量とAPIコスト情報の可視化
  - シミュレーションパラメータの調整機能（為替レート、API単価など）
  - 収益設計基準に基づく最適トークン配布量の計算
- 異常検知と制限管理
  - 異常な使用パターンの検出とアラート
  - 制限超過時の自動制限適用
  - 組織別の上限設定・調整機能
- システム全体の収益予測と最適化
  - プラン別の収益シミュレーション
  - 組織数変動に基づく月次・年次収益予測
  - 原価率と粗利率の最適化提案


## 6. 非機能要件

### 6.1 パフォーマンス
- 命式計算は1秒以内に完了すること
- クライアントデータ表示は2秒以内に表示されること
- 同時に最大30人のスタイリストが利用可能であること

### 6.2 セキュリティ
- クライアント個人情報の暗号化
- 役割ベースのアクセス制御（管理者/スタイリスト）
- ログイン履歴の記録と監視
- データバックアップと復元機能

### 6.3 ユーザビリティとデザインシステム

#### 6.3.1 全般的なユーザビリティ要件
- シンプルで直感的なUI（美容師が多忙な状況でも操作しやすい）
- タブレット操作に最適化されたレイアウト
- オフライン時の基本機能利用可能

#### 6.3.2 デザインシステムとテーマカラー
- 全アプリケーション共通のブランドカラー：ピンク (#f48fb1)を基調としたカラーパレット
  - メインカラー：#f48fb1（ピンク）
  - ライトカラー：#ffc1e3
  - ダークカラー：#bf5f82
  - アクセントカラー：#90caf9（水色）
- 白背景と組み合わせたクリーンで明るいデザイン（背景色：#f5f7fa）
- ボタンやアクティブ要素はピンク背景に白文字を基本とし、高コントラストで視認性を確保
- デバイス別最適化
  - SuperAdmin管理サイト：デスクトップ向け最適化
  - サロン管理者サイト：レスポンシブ（デスクトップ優先）
  - スタイリスト用アプリ：モバイルファースト設計
- Material Designベースのコンポーネントライブラリを活用（MUIフレームワーク採用）
- 日本語フォント：Noto Sans JP（可読性と現代的なデザインのバランス）
- アクセシビリティ対応：WCAG 2.1 AA基準を満たすコントラスト比の確保

### 6.4 互換性
- iOS/Android対応
- タブレット/スマートフォン対応
- 主要なブラウザ対応（Chrome, Safari, Firefox, Edge）

## 7. ページリスト

### 7.1 スタイリスト用モバイルアプリケーション（Client）

1. **ログイン・登録ページ**
   - **説明**: スタイリスト向けのログイン画面
   - **モックアップ**: `/login` (既存)
   - **主要機能**:
     - アカウントログイン
     - パスワードリセット

2. **運勢ページ `/fortune`**
   - **説明**: スタイリスト自身の運勢表示ページ
   - **モックアップ**: `/fortune` (既存)
   - **主要機能**:
     - 今日の運勢スコアと詳細表示
     - 施術に関連するアドバイス表示
     - ラッキーアイテム表示

3. **本日の施術クライアント一覧**
   - **説明**: その日担当する予定のクライアント一覧
   - **モックアップ**: `/mockups/beauty-daily-clients.html`
   - **主要機能**:
     - クライアント一覧（時間順）
     - 各クライアントの五行属性表示
     - クライアントとの相性スコア表示
     - クリックで詳細表示

4. **クライアントプロフィール**
   - **説明**: クライアントの詳細情報と命式分析結果
   - **モックアップ**: クライアント詳細モーダル（beauty-daily-clients内のモーダル）
   - **主要機能**:
     - 基本情報表示（名前、性別、連絡先等）
     - 四柱推命プロフィール表示（命式、五行バランス）
     - 性格特性と施術アドバイス
     - 施術履歴一覧
   - **関連ドキュメント**:
     - [データモデル設計](/docs/data_models/beauty-daily-clients.md)
     - [API仕様書](/docs/api/daily-clients.md)
     - [実装ガイド](/docs/implementation/beauty-daily-clients.md)

5. **クライアント直接入力・結果表示**
   - **説明**: 当日来店したクライアント向け入力・結果表示画面
   - **モックアップ**: `/mockups/beauty-client-input.html`
   - **関連ドキュメント**:
     - [API仕様書](/docs/api/beauty-client-input.md)
     - [実装ガイド](/docs/implementation/beauty-client-input.md)
   - **主要機能**:
     - 生年月日・時間の簡易入力フォーム
     - 性別選択
     - 命式計算と五行属性の即時表示
     - パーソナライズされたヘアスタイル・カラー提案
     - 結果の保存・共有機能
     - 既存顧客情報との自動紐付け機能
       - カレンダーや予約システムから取得した顧客情報との照合
       - 誕生日入力後の顧客データベース自動更新
       - 担当スタイリストによる入力支援機能
     - 収集データの中央DB連携（Client → Admin）

6. **一般チャット相談 `/chat`**
   - **説明**: スタイリスト自身の美容知識や技術に関する相談機能
   - **モックアップ**: `/chat`（既存）
   - **主要機能**:
     - 自由なテキスト入力
     - コンテクスト選択（自分の情報、任意のクライアント情報などを追加可能）
     - 相談履歴表示
     - 一般的な美容技術や四柱推命に関するアドバイス
     - ナレッジベースとしての活用

7. **クライアント専用チャット**
   - **説明**: 特定クライアントの四柱推命情報に基づいたパーソナライズされたチャット
   - **モックアップ**: `/mockups/beauty-client-chat.html`
   - **関連ドキュメント**:
     - [API仕様書](/docs/api/beauty-client-chat.md)
     - [データモデル設計](/docs/data_models/beauty-client-chat.md)
     - [実装ガイド](/docs/implementation/beauty-client-chat.md)
     - [UI設計書](/docs/ui/beauty-client-chat.md)
   - **主要機能**:
     - クライアント情報の自動コンテクスト設定
     - 当日の日柱情報に基づくアドバイス
     - ヘアスタイル・カラーのパーソナライズされた提案
     - クライアント別の会話履歴の永続化
     - サロン内でのチャット履歴共有

8. **プロフィール設定 `/profile`**
   - **説明**: スタイリスト自身のプロフィール表示・編集
   - **モックアップ**: `/profile`（既存）
   - **主要機能**:
     - 基本情報表示・編集
     - 命式情報表示
     - パスワード変更
     - 通知設定

### 7.2 サロン管理者サイト（Admin）

1. **管理者ダッシュボード**
   - **説明**: サロン全体の概要表示
   - **モックアップ**: `/mockups/beauty-admin-dashboard.html`
   - **API仕様**: `/docs/api/admin-dashboard.md`
   - **データモデル**: `/docs/data_models/admin-dashboard.md`
   - **実装ガイド**: `/docs/implementation/admin-dashboard.md`
   - **UI設計**: `/docs/ui/admin-dashboard.md`
   - **主要機能**:
     - スタイリスト・クライアント数表示
     - 今日の予約数表示
     - GPT-4oトークン使用状況グラフ（月間使用量/上限）
     - 未担当予約の一覧表示と割り当て管理

2. **クライアント管理**
   - **説明**: クライアント情報の一括管理
   - **モックアップ**: `/mockups/beauty-client-management.html`
   - **API仕様**: `/docs/api/client-management.md`
   - **実装ガイド**: `/docs/implementation/beauty-client-management.md`
   - **データモデル**: `/docs/data_models/beauty-client-management.md`
   - **主要機能**:
     - クライアント一覧表示
     - 四柱推命情報の自動計算と統合
     - スタイリストとの相性診断
     - 顧客メモと時系列記録
     - 検索・フィルタリング
     - クライアント情報編集
     - 削除・非表示設定

3. **データインポート**
   - **説明**: 外部データの取り込み
   - **モックアップ**: `/mockups/beauty-data-import.html`
   - **関連ドキュメント**:
     - [API仕様書](/docs/api/beauty-data-import.md)
     - [データモデル設計](/docs/data_models/beauty-data-import.md)
     - [実装ガイド](/docs/implementation/beauty-data-import.md)
     - [UI設計書](/docs/ui/beauty-data-import.md)
   - **主要機能**:
     - Googleカレンダー連携（予約情報の自動取得）
     - iCloudカレンダー連携（予約情報の自動取得）
     - CSVファイルアップロードとインポート
     - インポート履歴と結果管理

4. **スタイリスト管理**
    - **説明**: スタイリスト情報の管理
    - **モックアップ**: `/mockups/beauty-stylist-management.html`
    - **関連ドキュメント**:
      - [データモデル設計](/docs/data_models/beauty-stylist-management-update.md)
      - [実装計画書](/docs/implementation/beauty-stylist-management-implementation-plan.md)
      - [UI設計書](/docs/ui/beauty-stylist-management-update.md)
    - **主要機能**:
      - スタイリスト一覧表示（カード形式）
      - アカウント作成・編集
      - 権限設定
      - パスワード管理
      - スタイリスト削除
      - 四柱推命情報の閲覧（スタイリスト自身が入力した生年月日情報から算出）

5. **予約・担当管理**
    - **説明**: クライアントベースの予約と担当スタイリストの管理
    - **モックアップ**: `/mockups/beauty-appointment-management.html`
    - **関連ドキュメント**:
      - [API仕様書](/docs/api/appointment-management.md)
      - [データモデル設計](/docs/data_models/beauty-appointment-management.md)
      - [実装ガイド](/docs/implementation/beauty-appointment-management.md)
      - [UI設計書](/docs/ui/beauty-appointment-management.md)
    - **主要機能**:
      - 日付別クライアント一覧表示（カード形式）
      - 各カードに担当者選択機能（相性スコア表示）
      - 未割り当て予約のフィルタリング
      - 相性順のスタイリスト提案
      - タイムスロット調整（ドラッグ&ドロップ）
      - 直感的なUI（五行属性カラー識別）
      - Googleカレンダー/Appleカレンダー連携機能

6. **サポート管理**
    - **説明**: サポートチケットの作成・管理画面
    - **モックアップ**: `/mockups/beauty-admin-support.html`
    - **API仕様**: `/docs/api/support.md`
    - **実装ガイド**: `/docs/implementation/support-system.md`
    - **主要機能**:
      - サポートチケット一覧表示（すべて/未回答/回答済み）
      - 新規チケット作成フォーム
      - チケット詳細と会話履歴
      - 返信機能
      - ステータス管理（未回答/回答済み）

7. **請求・支払い管理**
    - **説明**: 組織の請求書確認・プラン管理・支払い方法設定（Ownerロール専用）
    - **モックアップ**: `/mockups/beauty-admin-billing.html`
    - **API仕様**: `/docs/api/billing.md`
    - **データモデル**: `/docs/data_models/beauty-admin-billing.md`
    - **実装ガイド**: `/docs/implementation/beauty-admin-billing.md`
    - **主要機能**:
      - 現在のプラン概要表示（プラン名、月額料金、次回更新日）
      - APIトークン使用状況の視覚的表示（使用量、残量、使用率をプログレスバーで表示）
      - 追加チャージ済みトークンの表示と残り会話数の目安
      - プラン詳細情報の表示（スタイリスト数上限、機能一覧、API制限など）
      - プラン変更機能
      - APIトークン追加チャージ購入機能
        - スタンダードチャージ（1,000,000トークン / 980円）
        - プレミアムチャージ（10,000,000トークン / 8,000円）
        - 購入後の即時反映と請求書への自動追加
      - 支払い方法の追加・編集・削除
      - 請求書履歴の表示（支払い済み、未払い、延滞中のフィルタリング）
      - 請求書詳細表示と請求書のダウンロード（トークン使用状況の詳細を含む）
      - 月額・年間プランの切り替えとそれぞれの料金比較

### 7.3 SuperAdmin管理サイト

1. **組織管理画面（メイン画面）**
   - **説明**: 組織（サロン）の管理（統計情報、組織の管理を一元化したメイン画面）
   - **モックアップ**: `/mockups/beauty-superadmin-organizations.html`
   - **主要機能**:
     - シンプルなメニュー構成（「組織管理」「課金・プラン管理」「サポート管理」のみ）
     - 統計情報表示（アクティブ組織数、トライアル中組織数、停止中組織数、スタイリスト総数など）
     - 組織の検索とフィルタリング（ステータス、プランなどで絞り込み）
     - 組織の一括操作（アクティブ化、トライアル延長、停止など）
     - 各組織のアクションメニュー（詳細表示、トライアル延長、プラン変更、停止など）
     - 新規組織登録（組織オーナー設定を含む）
     - 最小限のフォームフィールド（組織メールアドレス、地域などの不要フィールドを省略）
     - **組織詳細モーダル**:
       - 基本情報タブ：組織の連絡先、利用状況などの表示・編集
       - 組織オーナータブ：組織のオーナー管理者の情報表示、パスワードリセット、管理者変更
       - サブスクリプションタブ：契約プランの表示、変更、トライアル延長
       - サポート履歴タブ：サポートチケットの履歴表示、新規チケット作成

   **関連ドキュメント**:
   - [SuperAdmin API仕様書（4階層ロール対応）](/docs/api/superadmin-role-v2.md)
   - [4階層ロール構造の実装プラン](/docs/migration-notes/four-tier-role-implementation.md)
   - [4階層ロール構造のAPI設計・実装ガイド](/docs/api/admin-role-expansion.md)

2. **課金・プラン管理画面**
   - **説明**: プランの設定、収益シミュレーション、および請求書の管理を行う画面
   - **モックアップ**: `/mockups/beauty-superadmin-plans.html`
   - **API仕様**: `/docs/api/superadmin-plans.md`
   - **データモデル**: `/docs/data_models/beauty-superadmin-plans.md`
   - **UI設計**: `/docs/ui/beauty-superadmin-plans.md`
   - **実装ガイド**: `/docs/implementation/beauty-superadmin-plans.md`
   - **主要機能**:
     - 収益シミュレーションタブ：収益データの可視化と将来予測
       - 現在の収益概要（月額収益、APIコスト、利益率）の表示
       - シミュレーションパラメータの調整機能（為替レート、API単価、セッションサイズ、粗利率目標）
       - 収益設計基準に基づいた最適トークン配布・セッション数の表示
       - プラン別仮想組織数に基づく収益シミュレーション
     - プラン設定タブ：料金プランの作成・編集・管理
       - GPT-4oトークン使用制限の設定
       - プラン別機能制限の管理
       - 各プランの詳細情報（価格、特徴、利用組織数）の表示
     - 請求管理タブ：組織ごとの請求書管理
       - 請求書のステータス管理（支払い済み、支払い待ち、支払い遅延）
       - 請求書の操作（詳細表示、ダウンロード、再送信、支払い催促）
       - 請求書フィルタリングと検索機能

3. **サポートチケット管理画面**
   - **説明**: サポート依頼の管理（シンプルなチャット形式）
   - **モックアップ**: `/mockups/beauty-superadmin-support-simple.html`
   - **API仕様**: `/docs/api/support.md`
   - **実装ガイド**: `/docs/implementation/support-system.md`
   - **主要機能**:
     - チケット一覧（未回答/回答済みの2状態のみ）
     - シンプルな検索機能
     - 会話形式のチケット詳細表示
     - テキスト返信機能
     - ステータス自動更新（返信時に「回答済み」に変更）
     - 全組織からのチケットの一元管理


## 8. データモデル

### 8.1 統合データモデル設計

いろはアプリケーションの統合データモデル設計は、以下のドキュメントに詳細に記述されています：

- [統合データモデル設計書](/docs/data_models/integrated_model.md) - 詳細なデータモデル定義
- [エンティティ関係図（ERD）](/docs/data_models/erd.md) - エンティティ間の関係性を視覚化
- [共有型定義](/docs/data_models/shared_types.md) - フロントエンド・バックエンド間の型定義
- [Mongooseスキーマ実装例](/docs/data_models/mongoose_schemas.md) - データベーススキーマ実装

### 8.2 ユーザー（スタイリスト）
- ID, 名前, メールアドレス, パスワード, 役割（オーナー/管理者/スタイリスト）
- 役職情報（自由入力のテキストフィールド）
- プロフィール情報（写真, 経歴, 得意分野）
- 五行情報（自動算出される命式に基づく情報）
- サブスクリプションプランに基づく月間トークン使用制限情報

### 8.3 クライアント
- ID, 名前, 性別, 連絡先情報, 生年月日・時間
- 命式データ（年柱, 月柱, 日柱, 時柱, 天干地支）
- 五行バランス（水, 木, 火, 土, 金の割合）
- 写真, メモ, 髪質情報
- 外部ID情報（外部システムとの連携用）
  - ホットペッパーID（ホットペッパービューティーでの顧客ID）
  - サロンアンサーID（サロンアンサーでの顧客ID）
  - その他電子カルテシステムでの顧客ID
  - マッチング用識別子（電話番号、メールアドレス等のハッシュ値）

### 8.4 予約
- ID, クライアントID, スタイリストID (null可能：未担当の場合)
- 日時, 所要時間, 予約内容
- 状態（確定, キャンセル等）
- 備考
- 外部連携情報（外部システムからの予約の場合）
  - 外部予約ID（ホットペッパーや電子カルテシステム等の予約ID）
  - カレンダーイベントID（Google/iCloudカレンダーのイベントID）
  - 情報ソース（「ホットペッパー」「サロンアンサー」「手動入力」等）
  - 最終更新日時（同期時刻）

### 8.4 施術履歴
- ID, クライアントID, スタイリストID
- 日時, 施術内容, 使用製品
- 画像（ビフォー/アフター）
- スタイリストメモ

### 8.5 ヘアスタイルカタログ
- ID, スタイル名, 説明
- 画像, 特徴
- 適合五行タイプ, 適合顔型
- 季節情報, トレンド情報

### 8.6 相性データ
- クライアントID, スタイリストID
- 相性スコア, 相性理由
- 記録日時, マッチング根拠

### 8.7 日柱データ
- 日付, 天干, 地支
- 日柱の基本解説
- 最終更新日時

### 8.8 サポートチケット
- ID, 組織ID, 作成者ID（ユーザーID）
- タイトル, 詳細内容
- 作成日時, 最終更新日時
- ステータス（未回答, 回答済み, 解決済み, クローズ）
- 優先度（通常データのみ）

### 8.9 チケットメッセージ
- ID, チケットID, 送信者ID（ユーザーIDまたはスーパー管理者ID）
- 送信者タイプ（サロンスタッフ, スーパー管理者）
- メッセージ内容
- 送信日時
- 既読フラグ

### 8.10 トークン使用量
- 組織ID, ユーザーID
- タイムスタンプ
- プロンプトトークン数（入力）
- 完了トークン数（出力）
- 合計トークン数
- エンドポイント（'chat', 'image'など）
- セッションID
- コスト（計算値）
- モデル（'gpt-4o'）
- リクエスト識別子（外部APIリクエストID）

### 8.11 トークンチャージ購入履歴
- ID, 組織ID, ユーザーID（購入者）
- 購入日時
- チャージタイプ（'standard', 'premium'）
- トークン数（1,000,000または10,000,000）
- 金額
- 有効期限（通常は購入月の末日）
- 残りトークン数
- ステータス（'active', 'expired', 'exhausted'）
- 請求書ID（関連する請求書への参照）

## 9. 技術スタック

### 9.1 フロントエンド
- React / React Native（既存DailyFortuneアプリの基盤を活用）
- MUI（Material-UI）デザインシステム
- Chart.js（データ可視化）

### 9.2 バックエンド
- 既存のDailyFortuneアプリのバックエンド活用
- Node.js
- MongoDB（ユーザーデータ, クライアントデータ）

### 9.3 API・外部連携
- Google Calendar API（主要連携技術）
- iCloud Calendar API（主要連携技術）
- OpenAI API（GPT-4oモデル）
  - チャット機能
  - AIアドバイス機能
  - トークン使用量の管理・制限
- カレンダーを介した間接連携
  - ホットペッパービューティー → Googleカレンダー → いろは
  - 電子カルテシステム（サロンアンサー、エクストリンク等） → カレンダー → いろは
- OAuth 2.0認証による安全なカレンダー連携

## 10. 制約条件

- プライバシー法規制への準拠
- 既存のDailyFortuneアプリとの互換性維持
- 美容サロンでの実務フローとの整合性
- オフライン環境での基本機能動作
- 管理者サイト（admin）と美容師向けアプリの明確な機能分離
- 外部サービスの直接API連携に依存しないカレンダーベースの連携設計
- Googleカレンダー/iCloudカレンダーへのアクセス権限が必要

## 11. マイルストーン

1. **フェーズ1: 基盤構築** （3週間）
   - 既存DailyFortuneアプリからの移行設計
   - クライアント/スタイリストの四柱推命データモデル実装
   - 管理者サイト基本構造の実装

2. **フェーズ2: コア機能実装** （4週間）
   - 美容師向け基本機能（運勢表示、プロフィール、チャット）
   - クライアント管理基本機能
   - 管理者向け基本機能

3. **フェーズ3: 予約・マッチング機能** （3週間）
   - 予約表示機能
   - クライアントベース予約管理UI
   - スタイリストマッチング機能
   - 担当割り当て機能

4. **フェーズ4: データ連携・インポート** （3週間）
   - カレンダー連携機能実装（Google/Apple カレンダーAPI連携）
   - CSVインポート機能実装
   - カレンダーイベントからクライアントデータへの変換処理実装
   - 自動同期スケジュール機能実装

5. **フェーズ5: UI/UX改善とテスト** （3週間）
   - ベータテスト（美容サロン3店舗で）
   - フィードバック収集と機能改善
   - UI/UX調整

6. **フェーズ6: リリース準備** （2週間）
   - 最終テスト
   - ドキュメント作成
   - トレーニング資料作成
   - リリース