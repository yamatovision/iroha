# 美姫命プロジェクト・データモデル設計引き継ぎ文書

## 1. 概要と目的

本文書は美姫命（びきめい）プロジェクトのデータモデル設計に関する引き継ぎ資料です。既存のDailyFortuneアプリケーションを美容サロン向けに特化させるにあたり、データモデルを組織（Organization）中心の構造に再設計する方針を整理しています。この文書は設計の意図、確認済みファイル、実装の方向性を包括的に提供します。

## 2. 現状分析

### 2.1 既存モデル構造

現在のコードベースでは、以下のような構造が確認されています：

- **Userモデル**:
  - `organizationId`フィールドは存在するが、必須ではない状態
  - ユーザーは `role: 'SuperAdmin' | 'Admin' | 'User'` で権限管理
  - `jobTitle` フィールドは存在するが活用が限定的

- **Organizationモデル**:
  - 現状は限定的な構造（`name`, `superAdminId`, `subscriptionPlan`, `billingInfo`）
  - チーム機能の親エンティティとして使用されている
  - `superAdminId`によるUser参照が実装済み

- **Teamモデル**:
  - `organizationId`必須フィールドが存在（Organizationへの参照）
  - `adminId`, `creatorId`フィールドでUserへの参照が実装済み
  - チームメンバーは別途`TeamMembership`モデルで管理

### 2.2 モックアップ分析から得られた要件

美姫命で必要とされる要件（beauty-stylist-management.html, beauty-client-management.html, beauty-data-import.html）から：

- サロン単位でのデータ管理が基本
- スタイリスト、クライアント、予約などすべてがサロンに紐づく
- データインポートやカレンダー連携もサロン単位で管理

## 3. 設計方針

美姫命プロジェクトのデータモデルは「Organization（サロン）中心」の構造に移行することが最適と判断されました。その理由と影響範囲は以下の通りです：

### 3.1 Organization中心構造の利点

1. **データの自然な階層構造**:
   - サロン（Organization）が最上位エンティティ
   - スタイリスト（User）、クライアント（Client）、予約などが直接サロンに紐づく
   - 権限、予約、インポート設定など全てのサロン運営データが一元管理できる

2. **複数管理者のサポート**:
   - サロンには複数の管理者（オーナー、店長、マネージャーなど）が存在する可能性
   - Organizationに紐づけることで権限をもつUserを複数設定可能
   - 権限はUserの`role`フィールドで管理

3. **拡張性の向上**:
   - サロンチェーンなど複数拠点への将来的な拡張がしやすい
   - 組織構造の変更に対応しやすい
   - 複数ブランドの管理も容易

### 3.2 実装方針

美姫命の拡張データモデルでは以下の変更を行います：

1. **Organizationモデルの拡張**:
   - サロン詳細情報追加（住所、連絡先、営業時間など）
   - 管理設定情報追加（デフォルト施術時間、同期周期など）
   - 複数管理者対応（既存の`superAdminId`は残しつつ、`adminUserIds`の配列も追加）

2. **Userモデルの調整**:
   - `organizationId`を必須フィールドに変更（スタイリストは必ずサロンに所属）
   - 既存の`role`フィールドをそのまま活用し組織内権限を管理
   - 役職は`jobTitle`フィールドを引き続き使用
   - プロフィール画像URL用のフィールド追加

3. **新規モデルの追加**:
   - **Client**（クライアント）: 顧客情報、サロン特有情報、四柱推命プロファイル
   - **ImportConfig**（インポート設定）: 外部データソースとの連携設定
   - **ImportHistory**（インポート履歴）: インポート実行の記録
   - **CalendarIntegration**（カレンダー連携）: カレンダーAPIとの連携設定
   - **CalendarEventMapping**（カレンダーイベントマッピング）: 予約情報と内部データの紐付け

4. **モデル間関連**:
   - すべての主要モデルに`organizationId`を追加し、サロン単位でデータを区切る
   - スタイリスト（User）の識別にはUserIdを直接使用
   - メンバーシップデータは既存の構造を参考（例: TeamMembership）

## 4. 既存コードとの整合性

### 4.1 互換性を保つべき点

- User認証システム（JWT認証）
- 既存の四柱推命エンジンとの連携
- TeamMembershipに似た関連モデルの構造

### 4.2 移行戦略

1. Organizationモデルの拡張実装
2. Userモデルの必要な調整の実装
3. 新規モデル（Client, ImportConfig等）の実装
4. 既存データの移行スクリプト作成（必要に応じて）

## 5. 実装すべきモデル詳細

この節では、書き出し済みの仕様書を網羅的に取り込み、具体的な実装のガイドラインを提供します。

### 5.1 Organization（組織）モデル

```typescript
export interface IOrganization {
  _id?: mongoose.Types.ObjectId;
  name: string;                 // サロン名
  address?: string;             // 所在地
  contactInfo: {                // 連絡先情報
    phone: string;
    email: string;
    website?: string;
  };
  businessHours?: {             // 営業時間
    dayOfWeek: number;          // 0-6 (日-土)
    openTime: string;           // "HH:MM" 形式
    closeTime: string;          // "HH:MM" 形式
    isHoliday: boolean;         // 休業日フラグ
  }[];
  adminUserId: mongoose.Types.ObjectId;  // 主管理者ユーザーID（既存superAdminIdの代替）
  adminUserIds?: mongoose.Types.ObjectId[];  // 複数管理者をサポート
  settings?: {                  // サロン設定
    defaultSessionLength: number;  // デフォルト施術時間（分）
    calendarSyncInterval?: number; // カレンダー同期間隔（分）
    calendarSyncEnabled?: boolean; // カレンダー同期有効フラグ
  };
  subscriptionPlan: {           // 既存のサブスクリプション情報
    type: 'none' | 'active' | 'trial' | 'cancelled';
    isActive: boolean;
    currentPeriodStart: Date;
    currentPeriodEnd: Date;
  };
  billingInfo: {                // 既存の請求情報
    companyName?: string;
    contactName: string;
    contactEmail: string;
    address?: string;
    postalCode?: string;
    country?: string;
    taxId?: string;
    paymentMethodId?: string;
  };
  isActive: boolean;            // アクティブフラグ
  createdAt: Date;              // 作成日時
  updatedAt: Date;              // 更新日時
}
```

**メソッド実装**:
- `getStylists()`: サロンに所属するスタイリスト一覧を取得
- `getClients()`: サロンのクライアント一覧を取得
- `getActiveImportConfigs()`: 有効なインポート設定を取得

### 5.2 Client（クライアント）モデル

仕様書の詳細な記述に従い、以下の項目を含むモデルを実装します:

- 基本情報（名前、性別、連絡先）
- 四柱推命情報（生年月日、時間、計算結果）
- 外部システム連携情報（ホットペッパーID等）
- サロン特有フィールド（髪質情報、髪の悩み等）
- インポート情報と識別キー

### 5.3 ImportConfig / ImportHistory / CalendarIntegration

こちらも仕様書に記載された詳細な構造に従って実装します。特に:

- 認証情報のセキュアな保存
- フィールドマッピング設定
- カレンダーAPI連携
- インポート履歴のログ管理

## 6. 調査が必要な点

- 既存の認証システムとOrganization中心設計の統合方法
- 大量データのインポート時のパフォーマンス対策
- カレンダーAPI連携の最適実装（認証トークン管理）

## 7. 実装順序の推奨

1. Organization拡張モデルの実装
2. Userモデルの調整
3. Clientモデルの実装
4. インポート関連モデルの実装（ImportConfig, ImportHistory）
5. カレンダー連携機能の実装（CalendarIntegration, CalendarEventMapping）

## 8. ユーザー登録フロー

Organization中心のデータモデルにおいては、ユーザー登録フローも再設計が必要です。以下に主要な登録フローを説明します。

### 8.1 サロン新規登録（初回管理者登録）

このフローは美容サロンが初めて美姫命サービスに登録する場合です：

1. **サロン情報入力**:
   - サロン名、住所、連絡先情報の入力
   - 基本的なサロン設定（営業時間など）

2. **管理者アカウント作成**:
   - 管理者名、メールアドレス、パスワードの設定
   - 役職情報の入力
   - 管理者の四柱推命情報入力（任意）

3. **トランザクション処理**:
   - Organizationレコード作成
   - 管理者Userレコード作成（`role: 'Admin'`で設定）
   - User.organizationIdに新規作成したOrganizationのIDを設定
   - Organization.adminUserIdに新規作成したUserのIDを設定

4. **プラン選択・決済**:
   - サブスクリプションプラン選択
   - 決済情報入力
   - Organizationの`subscriptionPlan`情報を更新

5. **初期設定ガイド**:
   - サロン設定の詳細化ガイド表示
   - インポート機能やカレンダー連携のセットアップ案内

### 8.2 既存サロンへのスタイリスト追加

このフローは既存のサロンに新しいスタイリストを追加する場合です：

1. **管理者による招待**:
   - 管理者がスタイリスト追加画面から招待メールを送信
   - メールには招待コードまたはワンタイムリンクを含む

2. **スタイリスト情報入力**:
   - スタイリスト自身が招待から登録フォームにアクセス
   - 名前、メールアドレス、パスワード設定
   - 役職情報入力（シニアスタイリスト、アシスタントなど）
   - 四柱推命情報入力（推奨）

3. **アカウント作成処理**:
   - Userレコード作成（`role: 'User'`で設定）
   - User.organizationIdに招待元のサロンIDを設定
   - サロンのスタイリストリストに追加

4. **プロフィール補完**:
   - アバター画像のアップロード
   - 詳細プロフィール情報の入力（経歴、得意分野など）
   - 詳細な四柱推命情報の入力（オプション）

### 8.3 特殊ケース：マルチサロン管理者

将来的な拡張として、複数サロンを管理するケースも考慮できます：

1. **既存管理者による新サロン追加**:
   - 管理者アカウントで新サロン追加機能を使用
   - 新しいOrganizationレコードを作成
   - 既存の管理者UserIDを新Organizationの管理者として設定

2. **サロン切り替え機能**:
   - UI上でのサロン切り替えドロップダウン実装
   - 各操作時に現在選択中のOrganizationコンテキストを参照
   - APIリクエストに適切なorganizationIdを含める

## 9. 必要なページ設計

Organization中心のデータモデルを実装するにあたり、以下の新規または更新ページが必要になります：

### 9.1 新規作成が必要なページ

1. **サロン登録ページ**
   - URL: `/salon-signup`
   - 機能: サロン情報と管理者情報の入力、プラン選択
   - 構成要素:
     - マルチステップフォーム（サロン基本情報→管理者情報→プラン選択）
     - サロン情報入力フォーム（名前、住所、連絡先など）
     - 管理者登録フォーム（名前、メール、パスワードなど）
     - プラン選択カード、決済情報フォーム

2. **スタイリスト招待/登録ページ**
   - URL: `/invite-stylist` (管理者用) と `/stylist-signup/:code` (招待受付用)
   - 機能: 新規スタイリストの招待、登録情報入力
   - 構成要素:
     - 招待メールフォーム（管理者側）
     - 招待コード入力または確認
     - スタイリスト情報入力フォーム（招待されたスタイリスト用）

3. **サロン設定ページ**
   - URL: `/salon-settings`
   - 機能: サロン情報の閲覧・編集、スタイリスト管理、設定変更
   - 構成要素:
     - サロンプロフィール編集フォーム
     - 営業時間設定
     - スタイリスト一覧・管理インターフェース

4. **サロン選択ドロップダウン**
   - 配置: ヘッダーまたはサイドバーの上部
   - 機能: マルチサロン管理者が操作対象のサロンを切り替え
   - 構成要素:
     - サロン選択ドロップダウン
     - 現在のサロンコンテキスト表示
     - 新規サロン追加ボタン

### 9.2 更新が必要な既存ページ

1. **ログインページ**
   - 更新内容: サロン選択機能の追加（複数サロンに所属する場合）
   - 構成要素:
     - 標準的なログインフォーム
     - サロン選択ドロップダウン（ログイン後表示、複数所属の場合）

2. **ユーザープロフィールページ**
   - 更新内容: 所属サロン情報の表示、役職情報の強化
   - 構成要素:
     - サロン情報表示
     - 役職表示・編集
     - 所属チーム一覧

3. **管理者ダッシュボード**
   - 更新内容: サロンレベルの統計・情報表示
   - 構成要素:
     - サロン全体の利用統計
     - スタイリスト一覧
     - リソース使用状況

### 9.3 設計上の考慮点

1. **レスポンシブ設計**:
   - すべてのページはモバイル対応（スマートフォン、タブレット）
   - サロン管理画面は特にタブレット最適化

2. **アクセス制御**:
   - ユーザーの`role`とOrganizationIdの組み合わせによる権限チェック
   - 適切なエラーページやリダイレクト設定

3. **データコンテキスト**:
   - サロンコンテキストをReactコンテキストまたはReduxストアで管理
   - APIリクエストに自動的にOrganizationIdを含める仕組み

4. **ユーザー体験**:
   - サロン切り替え時のスムーズな状態更新
   - 適切なローディング状態とフィードバック

これらのページは必要最小限のものであり、美姫命プロジェクトの具体的な要件に応じて拡張することができます。

## 10. まとめと次のステップ

Organization中心の設計は美姫命プロジェクトのユースケースに最適です。既存のUserモデルも含め、すべてのデータをOrganizationに紐づけることで、サロン単位のデータ管理が実現できます。この設計により、複数管理者のサポート、データの一貫性維持、将来的な拡張性の確保が可能になります。

ユーザー登録フローとページ設計の概要を踏まえ、実装の際には以下の点に特に注意が必要です：

1. トランザクショナルな登録処理の実装
2. 権限管理のセキュリティ強化
3. 直感的なUI/UXデザイン

現状はデータモデル設計が完了し、これらの設計に基づく実装段階に移行する準備が整いました。次のステップとして実際のモデル実装と、既存データ構造からの移行計画の策定を行います。