# 美姫命 データインポート機能 - UI設計書

## 1. 概要

データインポート機能は、美容サロン管理者がCSVファイルやカレンダー連携（Google/iCloud）を通じてクライアント情報を取り込むための機能です。本ドキュメントでは、この機能のUI設計とユーザーエクスペリエンスフローについて詳細に定義します。カレンダーサービスを中間統合レイヤーとして活用し、様々な予約システムからのデータ取り込みを簡素化します。

## 2. 画面構成

データインポート機能は、以下の主要画面で構成されます：

1. **データインポートホーム画面** - インポート方法の選択
2. **CSVアップロード画面** - CSVファイルのアップロードとプレビュー
3. **フィールドマッピング画面** - CSVカラムとシステムフィールドの対応付け
4. **インポートプレビュー・実行画面** - データ確認と処理実行
5. **インポート進捗・結果画面** - 処理状況と結果の表示
6. **インポート履歴画面** - 過去のインポート一覧と詳細
7. **カレンダー連携設定画面** - Googleカレンダー/iCloudカレンダーとの連携設定

### 2.1 レイアウト共通要素

- **ヘッダー**: アプリケーションロゴ、ページタイトル、ユーザーメニュー
- **ナビゲーション**: サイドメニュー（モバイルではハンバーガーメニュー）
- **フッター**: 著作権情報、サポートリンク
- **パンくずリスト**: 現在の位置を示すパンくずナビゲーション
- **アクションバー**: 主要な操作ボタン（保存、キャンセルなど）

### 2.2 レスポンシブデザイン対応

- デスクトップ（1200px以上）: フルレイアウト表示
- タブレット（768px〜1199px）: コンテンツ領域の調整、2カラムレイアウト
- モバイル（767px以下）: 単一カラムレイアウト、スタック表示、簡略化されたUI

## 3. 画面詳細

### 3.1 データインポートホーム画面

**目的**: ユーザーにインポート方法の選択肢を提供する最初の画面

#### コンポーネント構成
- **ページヘッダー**
  - タイトル: "データインポート"
  - アクション: "インポート履歴" ボタン

- **インポート方法カード**
  - **CSVファイルカード**
    - アイコン: ファイルアイコン
    - タイトル: "CSVファイルからインポート"
    - 説明: "CSVファイルから顧客データを一括でインポートします"
    - アクション: "CSVインポート開始" ボタン
  
  - **Googleカレンダーカード**
    - アイコン: Googleカレンダーアイコン
    - タイトル: "Googleカレンダー連携"
    - 説明: "Googleカレンダーの予約情報を自動インポートします"
    - ステータス: 接続状態表示（未接続/接続済み）
    - アクション: "接続設定" または "設定変更" ボタン
  
  - **iCloudカレンダーカード**
    - アイコン: iCloudアイコン
    - タイトル: "iCloudカレンダー連携"
    - 説明: "iCloudカレンダーの予約情報を自動インポートします"
    - ステータス: 接続状態表示（未接続/接続済み）
    - アクション: "接続設定" または "設定変更" ボタン

- **インポートガイド**
  - タイトル: "はじめてのデータインポート"
  - コンテンツ: カレンダー連携とCSVインポートについての簡単な説明とヒント
  - アクション: "詳細ガイドを見る" リンク

#### 状態管理
- カレンダー連携状態（接続済み/未接続）の表示
- 最近のインポート状態（成功/エラー）の表示

#### インタラクション
- カードクリックで対応するインポートフローを開始
- 接続済みのカレンダーカードには追加の「同期実行」ボタンを表示

### 3.2 CSVアップロード画面

**目的**: CSVファイルのアップロードと初期検証

#### コンポーネント構成
- **ステップインジケーター**
  - ステップ1: "ファイルアップロード" (現在)
  - ステップ2: "フィールドマッピング"
  - ステップ3: "プレビューと実行"
  - ステップ4: "結果確認"

- **ファイルアップロードエリア**
  - ドラッグ＆ドロップエリア
  - "ファイルを選択" ボタン
  - 対応ファイル形式とサイズ制限の説明
  - アップロード中プログレスバー（アップロード時のみ表示）

- **テンプレートダウンロード**
  - "CSVテンプレートをダウンロード" リンク
  - テンプレートサンプルの説明

- **アップロード後の情報表示** (ファイルアップロード後のみ表示)
  - ファイル名、サイズ、行数
  - 検出された文字コード
  - ヘッダー行の表示
  - 最初の5行のプレビュー（表形式）

- **アクションバー**
  - "戻る" ボタン
  - "次へ: フィールドマッピング" ボタン（ファイルアップロード後のみ有効）

#### 状態管理
- アップロード前/アップロード中/アップロード完了/エラー状態
- アップロード進捗（パーセンテージ表示）
- ファイル検証結果（ヘッダー検出状況など）

#### インタラクション
- ドラッグ＆ドロップまたはファイル選択ダイアログでファイル選択
- アップロード成功後、自動的にファイルプレビューを表示
- ファイル形式エラー時は、具体的なエラー内容と対処方法を表示

### 3.3 フィールドマッピング画面

**目的**: CSVのカラムとシステムフィールドを対応付ける

#### コンポーネント構成
- **ステップインジケーター** (3.2と同様、現在はステップ2)

- **マッピング設定テーブル**
  - 各行は1つのフィールドマッピングを表現
  - システムフィールド名とその説明（左側）
  - 対応するCSVカラム選択ドロップダウン（中央）
  - 有効/無効切り替えスイッチ（右側）
  - フィールドの重要度表示（必須/推奨/任意）
  - データ品質スコア表示（対応するCSVカラムのデータ品質を視覚的に表示）

- **システムフィールドグループ**
  - 基本情報（名前、性別など）
  - 連絡先情報（電話、メールなど）
  - 四柱推命関連情報（生年月日、生まれ時間）
  - カスタムフィールド

- **インポートオプション設定**
  - 既存データの更新許可スイッチ
  - マッチング方法選択（メールアドレス/電話番号/名前）
  - 四柱推命プロフィール自動作成スイッチ
  - エラー処理方法選択（すべて処理/エラー時中断）
  - 日付・時間フォーマット設定（必要に応じて）

- **アクションバー**
  - "戻る" ボタン
  - "マッピングをリセット" ボタン
  - "次へ: プレビュー" ボタン

#### 状態管理
- 各フィールドのマッピング状態（マッピング済み/未マッピング）
- 必須フィールドのマッピング状況によるボタン有効/無効制御
- マッピングの自動推測結果と確信度

#### インタラクション
- ドロップダウンでCSVカラムを選択
- スマート推測機能による初期マッピングの提案
- 必須フィールドが未マッピングの場合は次へ進めない
- フィールドごとのヘルプアイコンでヒント表示

### 3.4 インポートプレビュー・実行画面

**目的**: マッピング結果のプレビューと最終確認

#### コンポーネント構成
- **ステップインジケーター** (現在はステップ3)

- **インポート概要**
  - 総レコード数
  - 新規作成予定レコード数
  - 更新予定レコード数
  - 警告件数（予測される問題点）

- **データプレビューテーブル**
  - 最初の10件のデータをマッピング適用後の形式で表示
  - システムフィールド名でカラム表示
  - 潜在的な問題がある項目はハイライト表示

- **警告リスト** (警告がある場合のみ表示)
  - データ形式の問題
  - 必須項目の欠落
  - 重複の可能性があるレコード
  - その他の注意事項

- **インポート設定確認**
  - 選択されたマッピング設定の概要
  - 選択されたオプションの概要

- **アクションバー**
  - "戻る" ボタン
  - "インポート実行" ボタン

#### 状態管理
- プレビューデータの読み込み状態
- 警告の重大度による表示制御

#### インタラクション
- インポート実行ボタンクリックで確認ダイアログを表示
- 警告項目クリックで詳細情報を表示
- プレビューテーブルのカラムソート機能

### 3.5 インポート進捗・結果画面

**目的**: インポート処理の進捗状況と結果を表示

#### コンポーネント構成
- **ステップインジケーター** (現在はステップ4)

- **処理中UI** (処理中のみ表示)
  - 大きなプログレスバーと進捗率表示
  - 処理対象レコードの現在位置/全体数
  - 処理中の処理ステータス（「データ検証中」「新規登録処理中」など）
  - 経過時間と推定残り時間
  - 現在までの成功/失敗/スキップ件数

- **処理完了UI** (処理完了後に表示)
  - 完了ステータスアイコンと結果サマリー
  - 処理統計（全体数、登録数、更新数、スキップ数、エラー数）
  - 処理時間
  - 結果概要グラフ（円グラフなど）

- **エラーリスト** (エラーがある場合のみ表示)
  - エラー発生レコードの一覧
  - エラータイプごとのグループ化表示
  - エラー詳細と修正提案

- **アクションバー**
  - "結果をCSVでダウンロード" ボタン
  - "エラーログをダウンロード" ボタン (エラーがある場合)
  - "完了" ボタン
  - "エラーがあるレコードを再インポート" ボタン (エラーがある場合)

#### 状態管理
- インポート状態（処理中/完了/一部成功/失敗）
- リアルタイム進捗情報の更新
- エラー詳細の展開/折りたたみ状態

#### インタラクション
- 処理中は自動的に進捗状況を更新
- 処理完了時は結果サマリーを表示
- エラーリストのアイテムクリックでエラー詳細を表示

### 3.6 インポート履歴画面

**目的**: 過去のインポート履歴の一覧と詳細表示

#### コンポーネント構成
- **フィルターバー**
  - データソース選択（CSV/Googleカレンダー/iCloudカレンダー/すべて）
  - ステータス選択（成功/一部成功/失敗/すべて）
  - 日付範囲選択

- **インポート履歴テーブル**
  - 各行は1つのインポート履歴
  - 日時、データソース、ステータス、レコード数、実行者名を表示
  - ステータスは色分けアイコンで視覚的に表示
  - 操作カラムに「詳細」ボタン

- **履歴統計カード**
  - 総インポート数
  - 成功/一部成功/失敗の件数と割合
  - 最近のインポート傾向グラフ

- **ページネーション**
  - 履歴リストのページ切り替え

#### 状態管理
- フィルター適用状態
- ソート状態（カラム、昇順/降順）
- ページネーション状態

#### インタラクション
- フィルター変更で即時リスト更新
- 「詳細」ボタンクリックで詳細モーダル表示
- 履歴行クリックで展開表示（モバイル表示時）

### 3.7 カレンダー連携設定画面

**目的**: Google/iCloudカレンダーとの連携設定と管理

#### コンポーネント構成
- **連携サービス選択タブ**
  - "Googleカレンダー" タブ
  - "iCloudカレンダー" タブ

- **連携状態カード**
  - 連携状態（接続済み/未接続）
  - 最終同期日時
  - 次回予定同期日時
  - 連携アカウント情報

- **認証設定セクション** (未接続時)
  - 連携手順説明
  - "カレンダーと連携する" ボタン
  - 認証フロー説明

- **同期設定セクション** (接続済み時)
  - カレンダー選択（複数選択可能）
  - 同期頻度設定（15分/30分/1時間/3時間/6時間）
  - 同期範囲設定（過去と未来のどれだけの期間を同期するか）
  - イベントパターン設定（予約として扱うイベントの条件）

- **クライアントデータ抽出設定**
  - イベントタイトルからの顧客名抽出パターン設定
  - イベント説明からの連絡先抽出パターン設定
  - カレンダーイベントから顧客データへのマッピングルール
  - データ抽出プレビュー

- **自動インポート設定**
  - 自動インポート有効/無効スイッチ
  - 新規クライアント自動作成許可スイッチ
  - 未確定予約の扱い設定
  - 重複チェック設定

- **アクションバー**
  - "今すぐ同期" ボタン (接続済み時)
  - "設定を保存" ボタン
  - "連携を解除" ボタン (接続済み時)

#### 状態管理
- 連携認証状態
- 設定変更の保存状態
- 同期実行状態（アイドル/実行中）

#### インタラクション
- "カレンダーと連携する" ボタンクリックでOAuth認証フローを開始
- カレンダー選択でリアルタイムプレビュー表示
- "今すぐ同期" ボタンクリックで手動同期実行
- 同期実行中はプログレスインジケーターとステータスを表示
- カレンダーイベントからクライアントデータへの変換ルールをインタラクティブに設定・確認

## 4. コンポーネント設計

### 4.1 共通コンポーネント

#### 4.1.1 ステップインジケーター
```tsx
interface StepIndicatorProps {
  steps: string[];     // ステップ名の配列
  currentStep: number; // 現在のステップ（0ベース）
  completedSteps: number[]; // 完了したステップのインデックス配列
}
```

#### 4.1.2 ファイルアップローダー
```tsx
interface FileUploaderProps {
  acceptedFileTypes: string[];  // 許可するファイル拡張子 (例: ['.csv'])
  maxFileSize: number;          // 最大ファイルサイズ（バイト）
  onFileSelected: (file: File) => void;
  onFileUploaded: (result: UploadResult) => void;
  multiple?: boolean;           // 複数ファイル選択許可
}
```

#### 4.1.3 フィールドマッピングテーブル
```tsx
interface FieldMappingProps {
  systemFields: SystemField[];  // システムフィールド定義
  csvHeaders: string[];         // CSVヘッダー
  initialMapping?: Record<string, string>; // 初期マッピング
  onChange: (mapping: Record<string, string>) => void;
}

interface SystemField {
  id: string;
  name: string;
  description: string;
  required: boolean;
  category: string;
  dataType: string;
  examples?: string[];
}
```

#### 4.1.4 プレビューテーブル
```tsx
interface PreviewTableProps {
  headers: string[];     // 表示するヘッダー
  data: any[];           // 表示するデータ行
  warnings?: Warning[];  // 警告情報（行、カラム位置付き）
  maxRows?: number;      // 最大表示行数
}
```

#### 4.1.5 プログレスバー
```tsx
interface ProgressBarProps {
  progress: number;       // 進捗率（0-100）
  status?: string;        // 状態表示テキスト
  showPercentage?: boolean; // パーセンテージ表示フラグ
  animated?: boolean;     // アニメーション効果
}
```

### 4.2 固有コンポーネント

#### 4.2.1 インポート方法カード
```tsx
interface ImportMethodCardProps {
  icon: React.ReactNode;    // 表示アイコン
  title: string;            // カードタイトル
  description: string;      // 説明文
  status?: 'connected' | 'disconnected' | 'error'; // 状態（カレンダー連携用）
  onClick: () => void;      // クリックハンドラ
  actionLabel?: string;     // アクションボタンラベル
  onAction?: () => void;    // アクションボタンクリックハンドラ
}
```

#### 4.2.2 インポート結果サマリー
```tsx
interface ImportResultSummaryProps {
  status: 'success' | 'partial' | 'failed';  // インポート結果状態
  stats: {
    total: number;           // 総レコード数
    imported: number;        // 新規登録数
    updated: number;         // 更新数
    skipped: number;         // スキップ数
    failed: number;          // 失敗数
  };
  processTime: number;       // 処理時間（秒）
  errors?: ErrorItem[];      // エラー情報
}
```

#### 4.2.3 カレンダー選択コンポーネント
```tsx
interface CalendarSelectorProps {
  availableCalendars: Calendar[]; // 利用可能なカレンダー一覧
  selectedCalendars: string[];    // 選択済みカレンダーID
  onChange: (selected: string[]) => void; // 変更ハンドラ
}

interface Calendar {
  id: string;
  name: string;
  color?: string;
  primary?: boolean;
}
```

#### 4.2.4 カレンダーイベント抽出ルール設定
```tsx
interface CalendarEventExtractionRuleProps {
  calendarId: string;            // カレンダーID
  titlePattern: string;          // タイトルからデータ抽出パターン
  descriptionPattern: string;    // 説明からデータ抽出パターン
  fieldMapping: Record<string, string>; // 抽出データとフィールドのマッピング
  sampleEvents: CalendarEvent[]; // サンプルイベントデータ
  onRuleChange: (rules: ExtractionRule) => void;
}
```

## 5. 状態管理設計

### 5.1 主要な状態

#### 5.1.1 CSVインポートプロセス状態
```typescript
interface CSVImportState {
  currentStep: number;       // 現在のステップ（0-3）
  uploadedFile: {            // アップロードファイル情報
    file: File | null;
    uploadId: string;
    headers: string[];
    previewRows: any[];
    recordCount: number;
  };
  mapping: {                 // マッピング設定
    fieldMapping: Record<string, string>;
    options: ImportOptions;
  };
  validationState: {         // バリデーション状態
    isValid: boolean;
    requiredFieldsMapped: boolean;
    warnings: Warning[];
  };
  importSession: {           // インポートセッション情報
    sessionId: string;
    importId: string;
    status: ImportStatus;
  };
  progress: {                // 進捗情報
    percentage: number;
    currentRecord: number;
    totalRecords: number;
    processedTime: number;
    estimatedTimeRemaining: number;
    stats: {
      imported: number;
      updated: number;
      skipped: number;
      failed: number;
    }
  };
  errors: ErrorItem[];       // エラー情報
}
```

#### 5.1.2 カレンダー連携状態
```typescript
interface CalendarConnectionState {
  connectedSources: {         // 接続済みソース情報
    google?: {
      id: string;
      status: ConnectionStatus;
      lastSync: Date;
      nextSync: Date;
      settings: CalendarSettings;
    };
    icloud?: {
      id: string;
      status: ConnectionStatus;
      lastSync: Date;
      nextSync: Date;
      settings: CalendarSettings;
    };
  };
  availableCalendars: Record<string, Calendar[]>; // 利用可能なカレンダー
  authState: {                // 認証状態
    isAuthenticating: boolean;
    authUrl?: string;
    error?: string;
  };
  syncState: {                // 同期状態
    isSyncing: boolean;
    progress?: number;
    currentOperation?: string;
  };
  extractionRules: {          // データ抽出ルール
    titlePatterns: string[];
    descriptionPatterns: string[];
    fieldMappings: Record<string, string>;
  };
  previewData: {              // 抽出プレビュー
    sampleEvents: CalendarEvent[];
    extractedClients: ClientData[];
  };
}
```

#### 5.1.3 インポート履歴状態
```typescript
interface ImportHistoryState {
  filters: {
    source?: string;
    status?: string;
    startDate?: Date;
    endDate?: Date;
  };
  pagination: {
    page: number;
    limit: number;
    total: number;
  };
  sortBy: {
    field: string;
    order: 'asc' | 'desc';
  };
  histories: ImportHistoryItem[];
  selectedHistory?: ImportHistoryItem;
  isLoading: boolean;
  error?: string;
}
```

### 5.2 状態遷移

#### 5.2.1 CSVインポートフロー状態遷移
```
初期状態
  ↓
ファイルアップロード状態 → [ファイル選択] → ファイルアップロード中 → アップロード完了
  ↓
フィールドマッピング状態 → [マッピング変更] → マッピングバリデーション → マッピング確定
  ↓
プレビュー状態 → [インポート実行] → 実行確認ダイアログ → 実行開始
  ↓
処理中状態 → [処理完了] → 結果表示状態
```

#### 5.2.2 カレンダー連携フロー状態遷移
```
未接続状態
  ↓
[連携開始] → 認証開始状態 → 認証リダイレクト → 認証コールバック処理 → 認証完了
  ↓
カレンダー選択状態 → [カレンダー選択] → データ抽出ルール設定状態 → ルール設定
  ↓
接続済み状態 → [設定変更] → 設定保存 → 設定適用
  ↓
[同期実行] → 同期中状態 → 同期完了 → 接続済み状態
```

## 6. インタラクションデザイン

### 6.1 ユーザーフロー

#### 6.1.1 CSVインポートフロー
1. データインポートホーム画面でCSVインポートを選択
2. ファイルをアップロード
3. システムフィールドとCSVカラムのマッピングを設定
4. インポートオプションを設定
5. マッピング結果のプレビューを確認
6. インポートを実行
7. インポート進捗を監視
8. 結果を確認し、必要に応じてエラー対応

#### 6.1.2 カレンダー連携フロー
1. データインポートホーム画面でカレンダー連携を選択
2. 連携するカレンダーサービス（GoogleまたはiCloud）を選択
3. 認証フローを完了
4. 同期するカレンダーを選択
5. カレンダーイベントからクライアントデータへの抽出ルールを設定
6. 抽出結果のプレビューを確認
7. 同期設定を構成
8. 設定を保存
9. 初回同期を実行し、結果を確認

### 6.2 エラーハンドリング

#### 6.2.1 ファイルアップロードエラー
- **非対応ファイル形式**: 「.csv形式のファイルのみアップロード可能です」というエラーメッセージを表示
- **ファイルサイズ超過**: 「ファイルサイズは最大10MBまでです」というエラーメッセージを表示
- **ネットワークエラー**: 「アップロード中にエラーが発生しました。再試行してください」というエラーメッセージと再試行ボタンを表示

#### 6.2.2 データエラー
- **必須フィールド欠落**: 該当フィールドをハイライト表示し、「必須フィールドです」というエラーメッセージを表示
- **形式不正**: データプレビューで該当セルをハイライト表示し、「形式が不正です」というツールチップを表示
- **重複データ**: 「既存データとの重複が検出されました」という警告を表示し、処理オプション（更新/スキップ）を選択させる

#### 6.2.3 カレンダー連携エラー
- **認証エラー**: 「認証に失敗しました」というエラーメッセージと再試行ボタンを表示
- **同期エラー**: エラーの種類と影響範囲を説明し、対処方法を提案
- **データ抽出エラー**: 抽出ルールの問題点をハイライトし、修正ガイダンスを提供

### 6.3 フィードバック

#### 6.3.1 視覚的フィードバック
- **処理状態表示**: プログレスバーとパーセンテージで進捗を表示
- **成功/失敗表示**: 色とアイコンで結果状態を視覚的に表示
- **データ品質表示**: データ品質スコアをカラーインジケーターで表示（赤/黄/緑）

#### 6.3.2 通知
- **処理完了通知**: インポート完了時に成功/失敗を通知
- **バックグラウンド処理通知**: カレンダー同期完了時に通知
- **定期的な同期結果通知**: 自動同期の結果と新規クライアント数などを要約した通知

## 7. アクセシビリティ

### 7.1 キーボードアクセシビリティ
- すべての対話要素はキーボードでアクセス可能
- フォーカスの視覚的表示
- ショートカットキーのサポート（例: Ctrl+Enter でフォーム送信）

### 7.2 スクリーンリーダー対応
- 適切なARIA属性の使用
- フォーム要素のラベル付け
- 状態変化の通知

### 7.3 その他のアクセシビリティ
- 十分なコントラスト比
- テキストサイズの調整サポート
- アニメーションの制御（必要に応じて無効化可能）

## 8. レスポンシブデザイン

### 8.1 デスクトップレイアウト（1200px以上）
- サイドバーを常時表示
- テーブルを完全表示
- 複数カラムレイアウト

### 8.2 タブレットレイアウト（768px〜1199px）
- サイドバーは常時表示または折りたたみ可能
- テーブルを水平スクロールで表示
- 2カラムレイアウトに調整

### 8.3 モバイルレイアウト（767px以下）
- サイドバーをハンバーガーメニューで表示
- テーブルをカード表示に変更
- 1カラムレイアウトでコンテンツをスタック表示
- タッチフレンドリーなUI要素（大きなボタン、十分なタッチ領域）

## 9. デザインシステム連携

### 9.1 カラーパレット
- プライマリー: 美姫命のブランドカラー (#f48fb1)
- セカンダリー: アクセントカラー (#90caf9)
- 成功: 緑系 (#4caf50)
- 警告: 黄色系 (#ff9800)
- エラー: 赤系 (#f44336)
- 背景: 明るい灰色 (#fafafa)
- テキスト: 濃い灰色 (#424242)

### 9.2 タイポグラフィ
- フォントファミリー: Roboto, sans-serif
- 見出し1: 24px, 600 weight
- 見出し2: 20px, 500 weight
- 見出し3: 16px, 500 weight
- 本文: 14px, 400 weight
- キャプション: 12px, 400 weight

### 9.3 コンポーネントスタイル
- Material Design ベースのUIコンポーネント
- アプリケーション全体で一貫したスタイル
- 美容サロン向けの柔らかく優しい印象のデザイン

## 10. 実装優先順位

### 10.1 最初期実装（MVP）
1. CSVアップロード基本機能
2. シンプルなフィールドマッピング
3. 基本的なインポート実行と結果表示
4. Googleカレンダー連携（基本認証と同期）
5. インポート履歴の基本表示

### 10.2 次期実装
1. スマートマッピング提案機能
2. 詳細なエラーハンドリングとレポート
3. カレンダーイベントからのデータ抽出ルール設定
4. 拡張されたデータプレビューと検証
5. iCloudカレンダー連携

### 10.3 将来拡張
1. インポートテンプレートの保存と再利用
2. 高度なデータクレンジング機能
3. 複数カレンダーの統合管理
4. 自動データ補完機能
5. クライアントデータ品質スコアリング